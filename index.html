<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>馬桶坐坐V1.1 - 測試板</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- 手機專用覆蓋樣式（PC 不載入） -->
    <link rel="stylesheet" href="css/mobile.css" media="(pointer: coarse), (max-width: 768px)">
    <link rel="preload" as="image" href="assets/images/background3.jpg">
    <link rel="preload" as="image" href="assets/images/background2.jpg">
</head>
<body>
    <div id="game-container">
        <!-- 開始畫面 -->
        <div id="start-screen" class="screen">
            <div class="start-bg"></div>
            <div class="start-overlay"></div>
            <div class="start-card">
                <div class="start-grid">
                    <div class="start-main">
                        <div class="start-header">
                            <img src="assets/images/LOGO.png" alt="LOGO" class="start-logo">
                        </div>

                        <!-- 左側單一視窗：預設顯示「遊戲玩法」 -->
                        <div class="content-window" id="content-window">
                            <h2 id="content-title">遊戲玩法</h2>
                            <!-- 左視窗底圖（依紅框位置），半透明不影響操作 -->
                            <div class="content-illustration" aria-hidden="true"></div>
                            <div id="content-body" class="content"></div>
                            <!-- 序號輸入疊蓋視窗（移入左側視窗內） -->
                            <div id="redeem-code-overlay" class="modal hidden">
                                <div class="modal-card">
                                    <h2>序號兌換</h2>
                                    <div class="redeem-code-form">
                                        <label for="redeem-code-input">輸入序號：</label>
                                        <input type="text" id="redeem-code-input" placeholder="請輸入序號" maxlength="50">
                                        <div id="redeem-code-message" class="redeem-code-message"></div>
                                    </div>
                                    <div class="modal-actions">
                                        <button id="redeem-code-submit" class="ghost">兌換</button>
                                        <button id="redeem-code-close" class="ghost">關閉</button>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- 隱藏模板：保留原始文案，作為切換來源 -->
                        <div class="info-templates hidden" aria-hidden="true">
                            <div id="tpl-gameplay">
                                <h2>遊戲玩法</h2>
                                <div class="content">
                                    <ul class="list">
                                        <li><span class="badge">建議</span> PC 電腦遊玩，使用 1080p 解析度。</li>
                                        <li><span class="badge">移動</span> 滑鼠點擊移動，或使用 <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> / <kbd>↑</kbd><kbd>↓</kbd><kbd>←</kbd><kbd>→</kbd>。</li>
                                        <li><span class="badge">暫停</span> 按 <kbd>ESC</kbd> 開啟詳細選單。</li>
                                        <li><span class="badge">技能</span> 能量達到 100 時，按 <kbd>Q</kbd> 施放大招。</li>
                                        <li><span class="badge">手機</span> 手機介面自動匹配，目前不支援大招。</li>
                                        <li><span class="badge">回報</span> BUG 回報：<a href="https://x.com/Yi_yuss" target="blank" rel="noopener">https://x.com/Yi_yuss</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div id="tpl-announce">
                                <h2>遊戲公告</h2>
                                <div class="content">
                                    <ul class="list">
                                        <li><span class="badge">福利</span> 每回報一條有效BUG，可領取1~10萬金幣序號，<a href="https://discord.gg/rdKVtjh5kG" target="blank" rel="noopener">點我回報</a></li>
                                        <li><span class="badge">徵稿</span> 歡迎有興趣的繪師一起參與二創，本作不涉及任何營利。</li>
                                        <li><span class="badge">版本</span> 將在V1.2版加入更多的角色、技能、天賦、地圖，以及嘗試角色像素動態化。</li>
                                        <li><span class="badge">託管</span> 使用 GitHub 免費空間，常常會非常卡，下午通常會好一點。</li>
                                        <li><span class="badge">存檔</span> 遊戲提供自動存檔，若主動清除瀏覽器資料，存檔會丟失，可善用手動備份。</li>
                                    </ul>
                                </div>
                            </div>
                            <div id="tpl-regarding">
                                <h2>Regarding</h2>
                                <div class="content">
                                    <ul class="list">
                                        <li><span class="badge">聲明</span> 遊戲為非官方之個人二次創作，僅供展示與娛樂，無任何商業用途。</li>
                                        <li><span class="badge">角色</span> <a href="https://www.youtube.com/@%E7%91%AA%E6%A0%BC%E9%BA%97%E7%89%B9margaretnorth" target="blank" rel="noopener">瑪格麗特</a>、<a href="https://www.youtube.com/@%E6%A3%AE%E6%A3%AE%E9%88%B4%E8%98%ADLilyLinglan" target="blank" rel="noopener">森森鈴蘭</a>、
<a href="https://www.youtube.com/@ReLiveDaDa" target="blank" rel="noopener">灰妲</a>、<a href="https://www.youtube.com/@Locolost65" target="blank" rel="noopener">洛可洛斯特</a>、<a href="https://www.youtube.com/@%E8%89%BE%E6%AF%94Rabi" target="blank" rel="noopener">艾比</a>、<a href="https://www.youtube.com/channel/UCOuJKc5wDEZmPEx3z6xfvbg" target="blank" rel="noopener">鳳梨不咬舌</a></li>

                                        <li><span class="badge">繪師</span> <a href="https://x.com/Linye274" target="blank" rel="noopener">凜夜 (像素人物)</a>、<a href="https://x.com/mellow9114" target="blank" rel="noopener">米歐 (像素建築)</a>、<a href="https://x.com/SlimeHeavy" target="blank" rel="noopener">HeavyMetalSlime (3D人物)</a> 感謝提供素材。

                                        <li><span class="badge">設定</span> 遊戲劇情皆為虛構，與任何VTuber之官方作品、立場或企劃皆無關聯。</li>

                                        <li><span class="badge">尊重</span> 若任何權利人有疑慮，請與我聯繫，我將立即配合修改或下架。</li>
                                        <li><span class="badge">聯絡</span> <a href="https://x.com/Yi_yuss" target="blank" rel="noopener">https://x.com/Yi_yuss</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="start-menu">
                        <div class="start-illustration" aria-hidden="true"></div>
                        <button id="start-button" class="menu-btn primary">開始遊戲</button>
                        <button id="achievements-button" class="menu-btn ghost">成就系統</button>
                        <button class="menu-btn ghost" data-target="gameplay">遊戲玩法</button>
                        <button class="menu-btn ghost" data-target="announce">遊戲公告</button>
                        <button class="menu-btn ghost" data-target="regarding">Regarding</button>
                        <button class="menu-btn ghost" data-target="redeem-code">序號輸入</button>
                        <button id="backup-button" class="menu-btn ghost">手動備份</button>
                    </div>

                    <!-- 音量疊蓋視窗已移至左側 content-window 內 -->
                </div>
            </div>

            <!-- 成就解鎖彈窗（勝利後回到開始介面時顯示；點外側即關閉） -->
            <div id="achievements-modal" class="hidden" aria-hidden="true">
              <div class="ach-modal-card" role="dialog" aria-label="新成就解鎖">
                <div class="ach-modal-header">
                  <div class="ach-modal-title">新成就解鎖</div>
                  <div class="ach-modal-sub">恭喜！以下成就已解鎖：</div>
                </div>
                <div id="achievements-modal-list" class="ach-modal-list" aria-live="polite"></div>
                <div class="ach-modal-tip">提示：點擊視窗外任意處可關閉。</div>
              </div>
            </div>
        </div>

        <!-- 新增：資源加載頁面 -->
        <div id="loading-screen" class="screen hidden">
            <div class="start-bg"></div>
            <div class="start-overlay"></div>
            <div class="start-card">
                <div class="start-grid">
                    <div class="start-main" style="text-align: center;">
                        <div class="start-header">
                            <img src="assets/images/LOGO.png" alt="LOGO" class="start-logo">
                        </div>
                        <div style="margin-top: 40px;">
                            <h2 style="color: #fff; margin-bottom: 20px;">正在載入資源...</h2>
                            <div style="width: 400px; max-width: 90%; margin: 0 auto;">
                                <div id="loading-progress-bar" style="width: 100%; height: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                                    <div id="loading-progress-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.3s ease;"></div>
                                </div>
                                <div id="loading-status" style="color: #fff; font-size: 14px; margin-top: 10px;">準備中...</div>
                                <div id="loading-details" style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 5px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增：引繼碼介面（生成/輸入/教學），保持既有版型 -->
        <div id="backup-screen" class="screen hidden">
            <div class="select-card">
                <h1 class="select-title">引繼碼</h1>
                <div class="map-desc" style="margin-bottom:12px;">
                  此介面用於跨裝置備份與還原您的進度。<br>
                  提示：本畫面分為「主體遊戲」與「冒險模式」兩組引繼碼，請依照需要選擇對應區塊操作。
                </div>
                <div class="map-grid" style="display:block;">
                    <div class="content" style="margin-bottom:12px;">
                        <h2 style="margin:0 0 6px;">主體遊戲引繼碼（生存 / 天賦 / 成就）</h2>
                        <p>說明：基於目前主體遊戲存檔（金幣、天賦、成就、解鎖角色）生成安全碼，不包含冒險模式世界。</p>
                        <button id="backup-generate" class="primary">生成引繼碼</button>
                        <div style="margin-top:8px;">
                            <label for="backup-code-output">主體遊戲引繼碼</label>
                            <input id="backup-code-output" type="text" readonly placeholder="點擊生成後顯示" style="width:100%;">
                            <button id="backup-copy" class="ghost" style="margin-top:6px;">複製</button>
                        </div>
                    </div>
                    <div class="content" style="margin-top:16px;">
                        <h2 style="margin:0 0 6px;">主體遊戲引繼碼輸入</h2>
                        <p>說明：貼上於其他裝置生成的「主體遊戲引繼碼」以還原主體存檔（不影響冒險模式）。</p>
                        <label for="backup-code-input">主體遊戲引繼碼</label>
                        <input id="backup-code-input" type="text" placeholder="請貼上引繼碼" style="width:100%;">
                        <button id="backup-apply" class="primary" style="margin-top:6px;">套用引繼碼</button>
                    </div>
                    <div class="content" style="margin-top:16px;">
                        <h2 style="margin:0 0 6px;">冒險模式引繼碼（異世界存檔）</h2>
                        <p>說明：此區塊只會備份 / 還原冒險模式中的「異世界」存檔，不會影響主體遊戲金幣、天賦或成就。</p>
                        <div style="margin-bottom:12px;">
                          <button id="adventure-backup-generate" class="primary">生成冒險模式引繼碼</button>
                          <div style="margin-top:8px;">
                            <label for="adventure-backup-code-output">冒險模式引繼碼</label>
                            <input id="adventure-backup-code-output" type="text" readonly placeholder="先在冒險模式遊玩並自動存檔後，再點此生成" style="width:100%;">
                            <button id="adventure-backup-copy" class="ghost" style="margin-top:6px;">複製</button>
                          </div>
                        </div>
                        <div>
                          <h2 style="margin:0 0 6px;">冒險模式引繼碼輸入</h2>
                          <p style="margin:0 0 4px;">貼上在其他裝置生成的「冒險模式引繼碼」，只會覆蓋異世界的世界存檔。</p>
                          <label for="adventure-backup-code-input">冒險模式引繼碼</label>
                          <input id="adventure-backup-code-input" type="text" placeholder="請貼上冒險模式引繼碼" style="width:100%;">
                          <button id="adventure-backup-apply" class="primary" style="margin-top:6px;">套用冒險模式引繼碼</button>
                        </div>
                    </div>
                    <div class="content" style="margin-top:16px;">
                        <h2 style="margin:0 0 6px;">教學與注意事項</h2>
                        <ul style="padding-left:18px; line-height:1.6;">
                            <li><strong>主體遊戲引繼碼</strong>：只包含金幣、天賦、成就、解鎖角色等資料，不會備份冒險模式世界。</li>
                            <li><strong>冒險模式引繼碼</strong>：只包含冒險模式「異世界」的自動存檔（地形、玩家道具等），不會改變主體遊戲存檔。</li>
                            <li>跨裝置時，請分別針對「主體遊戲」與「冒險模式」產生並套用對應的引繼碼。</li>
                            <li>若將冒險模式引繼碼貼到主體引繼碼欄位（或相反），系統會顯示版本不相容，請確認貼到正確區塊。</li>
                            <li>生成後請妥善保存，不要公開分享；任何人取得引繼碼都可以還原到相同存檔。</li>
                            <li>若瀏覽器或外掛阻擋剪貼簿，請手動選取輸出欄位內容後按 Ctrl+C 進行複製。</li>
                            <li>若版本更新造成資料欄位調整，系統會盡量維持向下相容，或在失敗時顯示提示訊息。</li>
                        </ul>
                    </div>
                    <button id="backup-back" class="ghost">返回開始畫面</button>
                </div>
            </div>
        </div>

        <!-- 成就介面：採用天賦版型（僅搬視覺與描述邏輯） -->
        <div id="achievements-screen" class="screen hidden">
          <div class="char-card-wrap">
            <h1 class="char-title">成就系統</h1>
            <p class="char-subtitle">提示：點選成就以查看下方介紹，未解鎖會顯示灰階。</p>

            <!-- 上方成就方格：沿用天賦的 6/4/3/2 欄 RWD -->
            <div id="achievements-list" class="char-grid talent-grid" aria-live="polite"></div>

            <!-- 下方預覽：顯示選取成就的圖示與描述（不包含解鎖操作） -->
            <div class="char-preview" id="achievements-preview" aria-live="polite">
              <div class="char-preview-image">
                <img id="achievements-preview-img" src="assets/images/GM.png" alt="預覽" />
              </div>
              <div class="char-preview-info">
                <div class="char-preview-name" id="achievements-preview-name">成就系統</div>
                <div class="char-preview-desc" id="achievements-preview-desc">這裡會顯示成就介紹。</div>
                <div class="char-preview-desc" id="achievements-preview-reward">提示：點選成就以查看詳細介紹，未解鎖會顯示灰階。</div>
              </div>
            </div>
            <button id="achievements-back" class="ghost">返回開始畫面</button>
          </div>
        </div>

        
        <!-- 選角介面 -->
        <div id="character-select-screen" class="screen hidden">
          <div class="char-card-wrap">
            <button id="talent-open" class="top-left-icon-btn talent-open" aria-label="天賦">
              <img src="assets/images/talent.png" alt="天賦" />
            </button>
            <h1 class="char-title">選擇VTuber角色</h1>
            <p class="char-subtitle">提示：選取角色後按空白鍵或雙擊確認。</p>

            <div class="char-grid">
              <button class="char-card selectable" data-char-id="margaret">
                <img src="assets/images/player1-3.png" alt="瑪格麗特·諾爾絲">
                <div class="char-name">瑪格麗特·諾爾絲</div>
              </button>
              <!-- 第二位角色：灰妲DaDa（未解鎖時灰階顯示，可花費金幣解鎖） -->
              <button class="char-card selectable locked" data-char-id="dada">
                <img src="assets/images/player2-3.png" alt="灰妲DaDa">
                <div class="char-name">灰妲DaDa</div>
              </button>
              <!-- 第四位角色：洛可洛斯特（未解鎖時灰階顯示，可花費1萬金幣解鎖） -->
              <button class="char-card selectable locked" data-char-id="rokurost">
                <img src="assets/images/player4-3.png" alt="洛可洛斯特">
                <div class="char-name">洛可洛斯特</div>
              </button>
              <!-- 第五位角色：艾比Rabi（未解鎖時灰階顯示，可花費1萬金幣解鎖） -->
              <button class="char-card selectable locked" data-char-id="rabi">
                <img src="assets/images/player5-3.png" alt="艾比Rabi">
                <div class="char-name">艾比Rabi</div>
              </button>
              <!-- 第六位角色：鳳梨不咬舌（未解鎖時灰階顯示，可花費1萬金幣解鎖） -->
              <button class="char-card selectable locked" data-char-id="pineapple">
                <img src="assets/images/player6-3.png" alt="鳳梨不咬舌">
                <div class="char-name">鳳梨不咬舌</div>
              </button>
              <div class="char-slot empty"></div>
              <div class="char-slot empty"></div>
              <div class="char-slot empty"></div>
              <div class="char-slot empty"></div>
              <div class="char-slot empty"></div>
              <div class="char-slot empty"></div>
              <!-- 第三位角色：森森鈴蘭（未解鎖時灰階顯示，可花費100萬金幣解鎖）- 最終角色，放在最後一格 -->
              <button class="char-card selectable locked" data-char-id="lilylinglan">
                <img src="assets/images/player3-3.png" alt="森森鈴蘭">
                <div class="char-name">森森鈴蘭</div>
              </button>

            </div>

            <div class="char-preview" id="char-preview" aria-live="polite">
              <div class="char-preview-image">
                <img id="char-preview-img" src="assets/images/GM.png" alt="預覽" />
              </div>
              <div class="char-preview-info">
                <div class="char-preview-name" id="char-preview-name">請先在上方選擇角色</div>
                <div class="char-preview-desc" id="char-preview-desc">這裡會顯示角色介紹與特色。</div>
                <div class="char-preview-skills" id="char-preview-skills"></div>
                <div class="char-hint">提示：每位角色的初始能力與技能會不同。</div>
              </div>
            </div>

            <!-- 角色解鎖確認對話框 -->
            <div id="character-confirm" class="hidden">
              <div class="talent-dialog">
                <div class="talent-dialog-title" id="character-confirm-title">解鎖角色</div>
                <div class="talent-dialog-desc" id="character-confirm-desc">使用0金幣解鎖該角色？</div>
                <div class="talent-dialog-actions">
                  <button id="character-confirm-ok" class="primary">確認</button>
                  <button id="character-confirm-cancel" class="ghost">取消</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 地圖選擇介面（重構：採用與選角一致的雙背景版型與布局） -->
        <div id="map-select-screen" class="screen hidden">
          <div class="char-card-wrap map-card-wrap">

            <!-- 左右分欄布局：左側模式、右側地圖格與下方介紹 -->
            <div class="map-layout">
              <!-- 左：模式欄，目前僅生存模式 -->
              <div class="map-menu">
                <div class="menu-title-image" aria-hidden="true">
                  <img src="assets/images/start3.png" alt="模式標題" />
                </div>
                <button id="mode-survival" class="mode-btn primary" aria-label="生存模式">生存模式</button>
                <button id="mode-challenge" class="mode-btn" aria-label="挑戰模式">挑戰模式</button>
                <button id="mode-stage" class="mode-btn" aria-label="闖關模式">闖關模式</button>
                <button id="mode-defense" class="mode-btn" aria-label="防禦模式">防禦模式</button>
                <button id="mode-main" class="mode-btn" aria-label="主線模式">主線模式</button>
                <button id="mode-adventure" class="mode-btn" aria-label="冒險模式">冒險模式</button>
                <button id="mode-3d" class="mode-btn" aria-label="3D模式">3D模式</button>
              </div>

              <!-- 右：地圖格與下方介紹 -->
              <div class="map-main">
                <div class="map-grid" id="grid-survival">
                  <button class="map-card selectable" data-map-id="city">
                    <img src="assets/images/background.jpg" alt="廁所LV.1">
                    <div class="map-name">LV1.廁所</div>
                  </button>
                  <button class="map-card selectable" data-map-id="forest">
                    <img src="assets/images/background1-2.png" alt="草原LV.2">
                    <div class="map-name">LV2.草原</div>
                  </button>
                  <button class="map-card selectable" data-map-id="desert">
                    <img src="assets/images/background1-3.png" alt="宇宙LV.3">
                    <div class="map-name">LV3.宇宙</div>
                  </button>
                  <button class="map-card selectable" data-map-id="garden">
                    <img src="assets/images/background8.png" alt="花園LV.4">
                    <div class="map-name">LV4.花園</div>
                  </button>
                  <button class="map-card selectable" data-map-id="intersection">
                    <img src="assets/images/background12.jpg" alt="路口LV.5">
                    <div class="map-name">LV5.路口</div>
                  </button>
                  <button class="map-card disabled" data-map-id="future-2">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                </div>

                <!-- 挑戰模式：-->
                <div class="map-grid hidden" id="grid-challenge">
                  <button class="map-card selectable" data-map-id="challenge-1">
                    <img src="assets/images/background4.png" alt="LV1.銀河系">
                    <div class="map-name">LV1.銀河系</div>
                  </button>
                  <button class="map-card selectable" data-map-id="challenge-2">
                    <img src="assets/images/background5.jpg" alt="LV2.星雲">
                    <div class="map-name">LV2.星雲</div>
                  </button>
                  <button class="map-card selectable" data-map-id="challenge-3">
                    <img src="assets/images/background6.jpg" alt="LV3.星軌">
                    <div class="map-name">LV3.星軌</div>
                  </button>
                  <button class="map-card selectable" data-map-id="challenge-4">
                    <img src="assets/images/background7.jpg" alt="LV4.黑洞">
                    <div class="map-name">LV4.黑洞</div>
                  </button>
                  <button class="map-card disabled" data-map-id="challenge-5">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="challenge-6">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                </div>

                <!-- 闖關模式：-->
                <div class="map-grid hidden" id="grid-stage">
                  <button class="map-card selectable" data-map-id="challenge-1">
                    <img src="assets/images/background4.png" alt="LV1.銀河系">
                    <div class="map-name">(施工中)</div>
                  </button>
                  <button class="map-card disabled" data-map-id="stage-2">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="stage-3">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="stage-4">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="stage-5">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="stage-6">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                </div>

                <!-- 防禦模式：-->
                <div class="map-grid hidden" id="grid-defense">
                  <button class="map-card selectable" data-map-id="defense-1">
                    <img src="assets/images/background1-2.png" alt="糖果煉金坊">
                    <div class="map-name">LV1.魔法糖果煉金坊</div>
                  </button>
                  <button class="map-card disabled" data-map-id="defense-2">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="defense-3">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="defense-4">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="defense-5">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="defense-6">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                </div>

                <!-- 主線模式：解鎖首張「冒險村莊」 -->
                <div class="map-grid hidden" id="grid-main">
                  <button class="map-card selectable" data-map-id="main-test">
                    <img src="assets/images/background10.jpg" alt="冒險村莊">
                    <div class="map-name">冒險村莊</div>
                  </button>
                  <button class="map-card disabled" data-map-id="main-2">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="main-3">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="main-4">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="main-5">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="main-6">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                </div>

                <!-- 冒險模式：單張地圖「異世界」（獨立存檔） -->
                <div class="map-grid hidden" id="grid-adventure">
                  <button class="map-card selectable" data-map-id="adventure-isekai">
                    <img src="assets/images/background9.jpg" alt="異世界">
                    <div class="map-name">異世界</div>
                  </button>
                  <button class="map-card disabled" data-map-id="adventure-2">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="adventure-3">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="adventure-4">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="adventure-5">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="adventure-6">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                </div>

                <!-- 3D模式：DEMO城市 -->
                <div class="map-grid hidden" id="grid-3d">
                  <button class="map-card selectable" data-map-id="3d-demo-city">
                    <img src="assets/images/background11.jpg" alt="DEMO城市">
                    <div class="map-name">DEMO城市</div>
                  </button>
                  <button class="map-card disabled" data-map-id="3d-2">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="3d-3">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="3d-4">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="3d-5">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                  <button class="map-card disabled" data-map-id="3d-6">
                    <img src="assets/images/background3.jpg" alt="尚未開放">
                    <div class="map-name">尚未開放</div>
                  </button>
                </div>

                <!-- 下方資訊區：左側 GM.png、右側介紹文字 -->
                <div class="map-info">
                  <div class="map-preview" aria-hidden="true">
                    <img id="map-preview-img" src="assets/images/GM.png" alt="預覽" />
                  </div>
                  <div id="map-desc" class="map-desc">提示：點擊地圖顯示介紹，雙擊或空白鍵確認</div>
                </div>
              </div>
            </div>

            <!-- 右下角美化返回鍵 -->
            <button id="map-cancel" class="return-btn ghost" aria-label="返回">返回</button>
          </div>
        </div>

        <!-- 3D模式密碼輸入疊蓋視窗（放在map-select-screen外面，確保能覆蓋整個屏幕） -->
        <div id="password-overlay" class="modal hidden" style="position: fixed; z-index: 10000; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;">
            <div class="modal-card" style="width: min(420px, 92vw); padding: 16px; background: var(--panel-bg); border: var(--border-soft); border-radius: 12px; box-shadow: var(--shadow-lg); backdrop-filter: blur(var(--blur-6));">
                <h2>輸入密碼</h2>
                <div class="redeem-code-form">
                    <label for="password-input">請輸入密碼以進入DEMO城市：</label>
                    <input type="password" id="password-input" placeholder="請輸入密碼" maxlength="50">
                    <div id="password-message" class="redeem-code-message"></div>
                </div>
                <div class="modal-actions">
                    <button id="password-submit" class="ghost">確認</button>
                    <button id="password-close" class="ghost">取消</button>
                </div>
            </div>
        </div>

    <!-- 難度選擇介面 -->
    <div id="difficulty-select-screen" class="screen hidden">
      <div class="select-card">
        <h1 class="select-title">選擇難度</h1>
            <div class="diff-grid">
              <button class="diff-card selectable" data-diff-id="EASY">
                <span class="diff-label">簡單</span>
                <div class="diff-intro">世界陷入了奇異的詛咒——<BR>所有 VTuber 都被神秘的「信號」控制，只要靠近她們的歌聲，就會忍不住想「坐下」。<BR><BR>你，唯一仍保持理智的玩家，必須在滿地馬桶迷宮中生存下來！</div>
              </button>
              <button class="diff-card selectable" data-diff-id="HARD">
                <span class="diff-label">困難</span>
                <div class="diff-intro">不斷傳來的詭異聲響，你以為只是廁所鬧鬼？<BR>來自深淵的「未知信號」<BR>都是在引導你走向那個終極馬桶！<BR><BR>在這裡，水花會奪命、歌聲會迷惑、<BR>每一秒的遲疑，都是墜入「坐下」的開始。</div>
              </button>
            </div>
            <div class="select-actions">
              <button id="diff-back" class="ghost">返回</button>
            </div>
          </div>
        </div>

    <!-- 第三張地圖專用：難度選擇介面（困難 / 修羅） -->
    <div id="desert-difficulty-select-screen" class="screen hidden">
      <div class="select-card">
        <h1 class="select-title">選擇難度</h1>
        <div class="diff-grid">
          <!-- 左：困難（樣式同原本） -->
          <button class="diff-card selectable" data-diff-id="HARD">
            <span class="diff-label">困難</span>
            <div class="diff-intro">不斷傳來的詭異聲響，你以為只是廁所鬧鬼？<br>來自深淵的「未知信號」<br>都是在引導你走向那個終極馬桶！<br><br>在這裡，水花會奪命、歌聲會迷惑、<br>每一秒的遲疑，都是墜入「坐下」的開始。</div>
          </button>
          <!-- 右：修羅（金色底色與指定介紹文案） -->
          <button class="diff-card selectable" data-diff-id="ASURA">
            <span class="diff-label">修羅</span>
            <div class="diff-intro">這不是為了生存，而是為了證明。<br>每一個「信號」都將襲來、<br>每一秒的遲疑都是坐下。<br><br>若你能在此地存活，你將不再是玩家，<br>——而是「信號」的支配者！</div>
          </button>
        </div>
        <div class="select-actions">
          <button id="diff-back-desert" class="ghost">返回</button>
        </div>
      </div>
    </div>

    <!-- 生存模式：單人 / 組隊選擇（僅生存模式使用；不影響其他模式） -->
    <div id="survival-online-select-screen" class="screen hidden">
      <div class="select-card team-dark">
        <h1 class="select-title">生存模式</h1>
        <div class="map-desc" style="margin-bottom:12px; text-align:center;">
          遊戲使用 官方專屬中繼伺服器 (Dedicated Relay) 進行連線。<br><br>
          不論是玩家彼此，或是開發者本人，都無法在遊戲中看到任何玩家的 IP 位址，且連線全程經由私人節點中繼，確保所有人的連線隱私與匿名安全。<br><br>
          組隊為測試版（最多5人）。<br><br>
          室長點「創建房間」取得房間碼，分享給朋友。<br><br>
          隊員在大廳輸入房間碼，點「加入房間」。<br><br>
          隊員點「準備」，室長確認地圖/難度後點「開始」。<br><br>
          如果連線不穩：隊員可按「重新連線」，室長可按「清理離線」。
        </div>
        <div style="margin-bottom:12px; display:flex; flex-direction:column; gap:8px; align-items:center;">
          <label style="font-weight:600; opacity:0.9;">你的暱稱（1~5個字符）</label>
          <input id="survival-online-nickname" type="text" placeholder="輸入暱稱（1~5個字符）" maxlength="5" style="width:min(300px, 80vw); padding:8px 12px; border-radius:6px; border:1px solid rgba(255,255,255,0.3); background:rgba(0,0,0,0.3); color:white; font-size:14px;">
          <div style="opacity:0.7; font-size:12px;">此暱稱會顯示在遊戲中玩家角色上方，並同步給所有玩家</div>
        </div>
        <div class="select-actions" style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button id="survival-online-btn-solo" class="primary">單人開始</button>
          <button id="survival-online-btn-online" class="ghost">組隊</button>
        </div>
        <div class="select-actions" style="margin-top:10px;">
          <button id="survival-online-btn-back" class="ghost">返回</button>
        </div>
      </div>
    </div>

    <!-- 生存模式：組隊大廳（僅生存模式使用） -->
    <div id="survival-online-lobby-screen" class="screen hidden">
      <div class="select-card team-dark">
        <h1 class="select-title">組隊大廳</h1>
        <div class="map-desc" style="margin-bottom:12px;">
          房間上限：5人。室長可開始遊戲、調整地圖/難度，所有玩家可選擇角色。<br>
          <span id="survival-online-status" style="color: rgba(255,255,255,0.85);">尚未連線</span>
        </div>

        <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-bottom:12px;">
          <button id="survival-online-create-room" class="primary">創建房間</button>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center;">
            <input id="survival-online-room-code" type="text" placeholder="輸入房間碼" maxlength="10" style="width:min(220px, 70vw);">
            <button id="survival-online-join-room" class="ghost">加入房間</button>
          </div>
        </div>

        <div class="content" style="margin-bottom:12px;">
          <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
            <div>
              <div style="font-weight:700;">房間碼：<span id="survival-online-room-code-display">-</span></div>
              <div style="opacity:0.85; font-size:12px;">提示：把房間碼給朋友輸入即可加入。</div>
            </div>
            <button id="survival-online-copy-room-code" class="ghost">複製房間碼</button>
          </div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1; min-width:220px;">
              <label style="display:block; margin-bottom:4px;">地圖（室長）</label>
              <select id="survival-online-host-map" style="width:100%;"></select>
            </div>
            <div style="flex:1; min-width:220px;">
              <label style="display:block; margin-bottom:4px;">難度（室長）</label>
              <select id="survival-online-host-diff" style="width:100%;">
                <option value="EASY">簡單</option>
                <option value="HARD">困難</option>
                <option value="ASURA">修羅</option>
              </select>
            </div>
          </div>
          <div style="margin-top:10px;">
            <label style="display:block; margin-bottom:4px;">選擇角色</label>
            <select id="survival-online-character-select" style="width:100%;"></select>
          </div>
        </div>

        <div class="content" style="margin-bottom:12px;">
          <div style="font-weight:700; margin-bottom:6px;">玩家列表</div>
          <div id="survival-online-members" style="display:grid; gap:6px;"></div>
        </div>

        <div class="select-actions" style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button id="survival-online-ready" class="ghost">準備</button>
          <button id="survival-online-start" class="primary">開始（室長）</button>
          <button id="survival-online-reconnect" class="ghost">重新連線</button>
          <button id="survival-online-cleanup" class="ghost">清理離線（室長）</button>
          <button id="survival-online-disband" class="ghost">解散隊伍（室長）</button>
          <button id="survival-online-leave" class="ghost">離開</button>
        </div>
      </div>
      
      <!-- M1：倒數計時覆蓋層（全螢幕，置於 lobby 之上） -->
      <div id="survival-online-countdown-overlay" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; display:flex; align-items:center; justify-content:center; flex-direction:column; pointer-events:none;">
        <div id="survival-online-countdown-text" style="font-size:48px; font-weight:700; color:#fff; text-shadow:0 0 20px rgba(255,255,255,0.5);">即將開始：3</div>
      </div>
    </div>
        
        <!-- 遊戲畫面 -->
        <div id="game-screen" class="screen hidden">
          <div id="viewport">
            <canvas id="game-canvas"></canvas>
        
            <!-- 遊戲UI（置於遊戲視窗內） -->
            <div id="game-ui">
              <div id="player-avatar"><img id="player-avatar-img" src="assets/images/player1-2.png" alt="玩家" /></div>
              <div id="level-info">
                <div class="ui-label">等級:</div>
                <div id="level-text">1</div>
              </div>
        
              <div id="health-bar-container">
                <div class="ui-label">血量:</div>
                <div id="health-bar">
                  <div id="health-fill"></div>
                </div>
                <div id="health-text">100/100</div>
              </div>
        
              <div id="exp-bar-container">
                <div class="ui-label">經驗:</div>
                <div id="exp-bar">
                  <div id="exp-fill"></div>
                </div>
                <div id="exp-text">0/100</div>
              </div>
        
              <div id="energy-bar-container">
                <div class="ui-label">能量:</div>
                <div id="energy-bar">
                  <div id="energy-fill"></div>
                </div>
                <div id="energy-text">0/100</div>
              </div>
        
              <div id="timer">00:00</div>
              <div id="wave-info">波次: 1</div>
              
              <!-- 金幣顯示（右上角） -->
              <div id="coins-display">
                <img src="assets/images/money.png" alt="金幣" id="coins-icon">
                <span id="coins-text">0</span>
              </div>
              
              <!-- M1：組隊模式 HUD 顯示（僅在組隊模式下顯示，右下角） -->
              <div id="multiplayer-session-info" class="hidden" style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.6); padding:8px 12px; border-radius:6px; font-size:11px; color:rgba(255,255,255,0.9); border:1px solid rgba(255,255,255,0.2); z-index:100; min-width:180px; max-width:250px;">
                <div style="opacity:0.7; margin-bottom:6px; font-weight:600;">組隊中</div>
                <div id="multiplayer-session-id" style="font-family:monospace; font-size:10px; margin-bottom:8px; opacity:0.85; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.1);">-</div>
                <div id="multiplayer-players-list" style="font-size:10px; line-height:1.6; max-height:120px; overflow-y:auto;">
                  <!-- 玩家列表將在這裡動態生成 -->
                </div>
              </div>
            </div>
        
            <!-- 升級選單（置於遊戲視窗內） -->
            <div id="level-up-menu" class="hidden">
              <h2>Level up!</h2>
              <div id="upgrade-options"></div>
            </div>
        
            <!-- 技能頁（ESC觸發，顯示技能清單與音量調整） -->
            <div id="skills-menu" class="hidden">
              <div class="skills-title">技能與音量</div>
              <div class="skills-hint">按 ESC 關閉</div>
              <!-- 左上角：EXP 音效切換按鈕 -->
              <button id="exp-sound-toggle" class="top-left-icon-btn" aria-label="切換經驗音效">
                <span id="exp-sound-toggle-text">EXP音效：開</span>
              </button>
              <!-- 左上角：死亡音效切換按鈕（位於 EXP 下方） -->
              <button id="death-sound-toggle" class="top-left-icon-btn" aria-label="切換死亡音效" style="top: 40px; left: 12px;">
                <span id="death-sound-toggle-text">死亡音效：開</span>
              </button>
              <div class="skills-volume">
                <div class="volume-row">
                  <label for="skills-music-volume">音樂</label>
                  <input type="range" id="skills-music-volume" min="0" max="1" step="0.01" value="0.5">
                  <span id="skills-music-volume-text">50%</span>
                </div>
                <div class="volume-row">
                  <label for="skills-sound-volume">音效</label>
                  <input type="range" id="skills-sound-volume" min="0" max="1" step="0.01" value="0.7">
                  <span id="skills-sound-volume-text">70%</span>
                </div>
              </div>
              <div id="skills-list" class="skills-list" aria-live="polite"></div>
            </div>
            <!-- 挑戰模式專用 HUD（獨立容器，避免污染生存模式） -->
            <div id="challenge-ui" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:3; pointer-events:none;">
              <!-- 左上：頭像、HP、EXP、能量 -->
              <div id="challenge-left" style="position:absolute; top:10px; left:10px; display:flex; gap:10px; align-items:flex-start;">
                <img id="challenge-avatar" alt="avatar" style="width:80px; height:80px; image-rendering:pixelated; border:2px solid #fff; border-radius:6px;" />
                <div style="display:flex; flex-direction:column; gap:6px;">
                  <div class="cbar-row">
                    <span class="cbar-label">生命</span>
                    <div id="challenge-health-bar" class="cbar"><div id="challenge-health-fill" class="cbar-fill" style="background:#ff4d4f;"></div></div>
                    <span id="challenge-health-text" class="cbar-text">0/0</span>
                  </div>
                  <div class="cbar-row">
                    <span class="cbar-label">經驗</span>
                    <div id="challenge-exp-bar" class="cbar"><div id="challenge-exp-fill" class="cbar-fill" style="background:#52c41a;"></div></div>
                    <span id="challenge-exp-text" class="cbar-text">0/0</span>
                  </div>
                  <div class="cbar-row">
                    <span class="cbar-label">能量</span>
                    <div id="challenge-energy-bar" class="cbar"><div id="challenge-energy-fill" class="cbar-fill" style="background:#40a9ff;"></div></div>
                    <span id="challenge-energy-text" class="cbar-text">0/0</span>
                  </div>
                </div>
              </div>
              <!-- 右上：時間、金幣 -->
              <div id="challenge-right" style="position:absolute; top:10px; right:10px; display:flex; flex-direction:column; gap:10px; align-items:flex-end;">
                <div id="challenge-timer" style="font-size:1.4rem; font-weight:bold; color:#fff; text-shadow:0 0 6px rgba(0,0,0,0.6);">00:00</div>
                <div id="challenge-coins" style="display:flex; align-items:center; gap:6px; color:#ffd700; font-weight:bold; text-shadow:0 0 5px rgba(255,215,0,0.6);">
                  <img id="challenge-coins-icon" src="assets/images/money.png" alt="金幣" style="width:24px; height:24px;"/>
                  <span id="challenge-coins-text">0</span>
                </div>
              </div>
              <!-- 右下：操作提示圖例 -->
              <div id="challenge-legend" style="position:absolute; right:12px; bottom:12px; color:#ffffff; font-size:1.0rem; font-weight:600; text-shadow:0 0 6px rgba(0,0,0,0.6); pointer-events:none;">
                Z=攻擊&nbsp;&nbsp;X=衝刺
              </div>
            </div>

            <!-- 挑戰模式 ESC 菜單（僅視覺採用生存樣式，避免邏輯污染） -->
            <div id="challenge-menu" class="hidden">
              <div class="skills-title">技能與音量</div>
              <div class="skills-hint">按 ESC 關閉</div>
              <div class="skills-volume">
                <div class="volume-row">
                  <label for="challenge-music-volume">音樂</label>
                  <input type="range" id="challenge-music-volume" min="0" max="1" step="0.01" value="0.5">
                  <span id="challenge-music-volume-text">50%</span>
                </div>
                <div class="volume-row">
                  <label for="challenge-sound-volume">音效</label>
                  <input type="range" id="challenge-sound-volume" min="0" max="1" step="0.01" value="0.7">
                  <span id="challenge-sound-volume-text">70%</span>
                </div>
              </div>
              <div class="talents-section">
                <h3 class="talents-title">目前天賦</h3>
                <ul id="challenge-talents-list" class="talents-list" style="list-style:none; padding:0; margin:0;"></ul>
              </div>
            </div>

            <!-- 闖關模式專用 HUD（獨立容器） -->
            <div id="stage-ui" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:3; pointer-events:none;">
              <!-- 左上：頭像、HP、EXP、能量 -->
              <div id="stage-left" style="position:absolute; top:10px; left:10px; display:flex; gap:10px; align-items:flex-start;">
                <img id="stage-avatar" alt="avatar" style="width:80px; height:80px; image-rendering:pixelated; border:2px solid #fff; border-radius:6px;" />
                <div style="display:flex; flex-direction:column; gap:6px;">
                  <div class="cbar-row">
                    <span class="cbar-label">生命</span>
                    <div id="stage-health-bar" class="cbar"><div id="stage-health-fill" class="cbar-fill" style="background:#ff4d4f;"></div></div>
                    <span id="stage-health-text" class="cbar-text">0/0</span>
                  </div>
                  <div class="cbar-row">
                    <span class="cbar-label">經驗</span>
                    <div id="stage-exp-bar" class="cbar"><div id="stage-exp-fill" class="cbar-fill" style="background:#52c41a;"></div></div>
                    <span id="stage-exp-text" class="cbar-text">0/0</span>
                  </div>
                  <div class="cbar-row">
                    <span class="cbar-label">能量</span>
                    <div id="stage-energy-bar" class="cbar"><div id="stage-energy-fill" class="cbar-fill" style="background:#40a9ff;"></div></div>
                    <span id="stage-energy-text" class="cbar-text">0/0</span>
                  </div>
                </div>
              </div>
              <!-- 右上：時間、金幣 -->
              <div id="stage-right" style="position:absolute; top:10px; right:10px; display:flex; flex-direction:column; gap:10px; align-items:flex-end;">
                <div id="stage-timer" style="font-size:1.4rem; font-weight:bold; color:#fff; text-shadow:0 0 6px rgba(0,0,0,0.6);">00:00</div>
                <div id="stage-coins" style="display:flex; align-items:center; gap:6px; color:#ffd700; font-weight:bold; text-shadow:0 0 5px rgba(255,215,0,0.6);">
                  <img id="stage-coins-icon" src="assets/images/money.png" alt="金幣" style="width:24px; height:24px;"/>
                  <span id="stage-coins-text">0</span>
                </div>
              </div>
            </div>

            <!-- 闖關模式 ESC 菜單（複製挑戰樣式） -->
            <div id="stage-menu" class="hidden">
              <div class="skills-title">技能與音量</div>
              <div class="skills-hint">按 ESC 關閉</div>
              <div class="skills-volume">
                <div class="volume-row">
                  <label for="stage-music-volume">音樂</label>
                  <input type="range" id="stage-music-volume" min="0" max="1" step="0.01" value="0.5">
                  <span id="stage-music-volume-text">50%</span>
                </div>
                <div class="volume-row">
                  <label for="stage-sound-volume">音效</label>
                  <input type="range" id="stage-sound-volume" min="0" max="1" step="0.01" value="0.7">
                  <span id="stage-sound-volume-text">70%</span>
                </div>
              </div>
              <div class="talents-section">
                <h3 class="talents-title">目前天賦</h3>
                <ul id="stage-talents-list" class="talents-list" style="list-style:none; padding:0; margin:0;"></ul>
              </div>
            </div>

            <!-- 防禦模式專用 HUD（獨立容器） -->
            <div id="defense-ui" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:3; pointer-events:none;">
              <!-- 左上：頭像、HP、EXP、能量 -->
              <div id="defense-left" style="position:absolute; top:10px; left:10px; display:flex; gap:10px; align-items:flex-start;">
                <img id="defense-avatar" alt="avatar" style="width:80px; height:80px; image-rendering:pixelated; border:2px solid #fff; border-radius:6px;" />
                <div style="display:flex; flex-direction:column; gap:6px;">
                  <div class="cbar-row">
                    <span class="cbar-label">生命</span>
                    <div id="defense-health-bar" class="cbar"><div id="defense-health-fill" class="cbar-fill" style="background:#ff4d4f;"></div></div>
                    <span id="defense-health-text" class="cbar-text">0/0</span>
                  </div>
                  <div class="cbar-row">
                    <span class="cbar-label">經驗</span>
                    <div id="defense-exp-bar" class="cbar"><div id="defense-exp-fill" class="cbar-fill" style="background:#52c41a;"></div></div>
                    <span id="defense-exp-text" class="cbar-text">0/0</span>
                  </div>
                  <div class="cbar-row">
                    <span class="cbar-label">能量</span>
                    <div id="defense-energy-bar" class="cbar"><div id="defense-energy-fill" class="cbar-fill" style="background:#40a9ff;"></div></div>
                    <span id="defense-energy-text" class="cbar-text">0/0</span>
                  </div>
                </div>
              </div>
              <!-- 右上：時間、金幣 -->
              <div id="defense-right" style="position:absolute; top:10px; right:10px; display:flex; flex-direction:column; gap:10px; align-items:flex-end;">
                <div id="defense-timer" style="font-size:1.4rem; font-weight:bold; color:#fff; text-shadow:0 0 6px rgba(0,0,0,0.6);">00:00</div>
                <div id="defense-coins" style="display:flex; align-items:center; gap:6px; color:#ffd700; font-weight:bold; text-shadow:0 0 5px rgba(255,215,0,0.6);">
                  <img id="defense-coins-icon" src="assets/images/money.png" alt="金幣" style="width:24px; height:24px;"/>
                  <span id="defense-coins-text">0</span>
                </div>
              </div>
            </div>

            <!-- 防禦模式 ESC 菜單（複製挑戰樣式） -->
            <div id="defense-menu" class="hidden">
              <div class="skills-title">技能與音量</div>
              <div class="skills-hint">按 ESC 關閉</div>
              <div class="skills-volume">
                <div class="volume-row">
                  <label for="defense-music-volume">音樂</label>
                  <input type="range" id="defense-music-volume" min="0" max="1" step="0.01" value="0.5">
                  <span id="defense-music-volume-text">50%</span>
                </div>
                <div class="volume-row">
                  <label for="defense-sound-volume">音效</label>
                  <input type="range" id="defense-sound-volume" min="0" max="1" step="0.01" value="0.7">
                  <span id="defense-sound-volume-text">70%</span>
                </div>
              </div>
              <div class="talents-section">
                <h3 class="talents-title">目前天賦</h3>
                <ul id="defense-talents-list" class="talents-list" style="list-style:none; padding:0; margin:0;"></ul>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 失敗畫面 -->
        <div id="game-over-screen" class="screen hidden">
          <!-- 遊戲失敗影片 -->
          <video id="game-over-video" src="assets/videos/game_over.mp4" preload="auto" playsinline></video>
          
          <!-- 失敗結算視窗 -->
          <div class="game-over-summary">
            <div class="game-over-summary-content">
              <h2>遊戲結算</h2>
              <div class="summary-stats">
                <div class="summary-stat">
                  <span class="stat-label">遊戲時間(秒):</span>
                  <span class="stat-value" id="game-over-time">00:00</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">最終等級:</span>
                  <span class="stat-value" id="game-over-level">0</span>
                </div>
        
                <div class="summary-stat">
                  <span class="stat-label">獲得金幣:</span>
                  <span class="stat-value" id="game-over-coins">0</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">最終波數:</span>
                  <span class="stat-value" id="game-over-exp">0</span>
                </div>
              </div>
              <div id="game-over-achievements" class="summary-achievements" aria-live="polite" style="margin-top:12px;"></div>
            </div>
          </div>
        </div>
        
        <!-- 勝利畫面 -->
        <div id="victory-screen" class="screen hidden">
          <video id="victory-video" src="assets/videos/victory.mp4" preload="auto" playsinline></video>
          <!-- 結算視窗 -->
          <div id="victory-summary" class="victory-summary">
            <div class="victory-summary-content">
              <h2>遊戲勝利</h2>
              <div class="summary-stats">
                <div class="summary-stat">
                  <span class="stat-label">遊戲時間(秒):</span>
                  <span class="stat-value" id="summary-time">00:00</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">最終等級:</span>
                  <span class="stat-value" id="summary-level">0</span>
                </div>
          
                <div class="summary-stat">
                  <span class="stat-label">獲得金幣:</span>
                  <span class="stat-value" id="summary-coins">0</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">最終波數:</span>
                  <span class="stat-value" id="summary-exp">0</span>
                </div>
              </div>
              <div id="victory-achievements" class="summary-achievements" aria-live="polite" style="margin-top:12px;"></div>
            </div>
          </div>
        </div>
        
        <!-- 防禦模式專用結算畫面：失敗 -->
        <div id="defense-gameover-screen" class="screen hidden">
          <video id="defense-gameover-video" src="assets/videos/game_over.mp4" preload="auto" playsinline></video>
          <div class="game-over-summary">
            <div class="game-over-summary-content">
              <h2>防禦模式結算</h2>
              <div class="summary-stats">
                <div class="summary-stat">
                  <span class="stat-label">遊戲時間:</span>
                  <span class="stat-value" id="defense-failure-time">00:00</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">波次進度:</span>
                  <span class="stat-value" id="defense-failure-wave">0/30</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">獲得金幣:</span>
                  <span class="stat-value" id="defense-failure-gold">0</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">擊殺數:</span>
                  <span class="stat-value" id="defense-failure-kill">0</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">建造塔數:</span>
                  <span class="stat-value" id="defense-failure-tower">0</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">主堡血量:</span>
                  <span class="stat-value" id="defense-failure-base">0/0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 防禦模式專用結算畫面：勝利 -->
        <div id="defense-victory-screen" class="screen hidden">
          <video id="defense-victory-video" src="assets/videos/victory.mp4" preload="auto" playsinline></video>
          <div class="victory-summary">
            <div class="victory-summary-content">
              <h2>防禦模式勝利</h2>
              <div class="summary-stats">
                <div class="summary-stat">
                  <span class="stat-label">遊戲時間:</span>
                  <span class="stat-value" id="defense-victory-time">00:00</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">波次進度:</span>
                  <span class="stat-value" id="defense-victory-wave">0/30</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">獲得金幣:</span>
                  <span class="stat-value" id="defense-victory-gold">0</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">擊殺數:</span>
                  <span class="stat-value" id="defense-victory-kill">0</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">建造塔數:</span>
                  <span class="stat-value" id="defense-victory-tower">0</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-label">主堡血量:</span>
                  <span class="stat-value" id="defense-victory-base">0/0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 天賦介面 -->
        <div id="talent-select-screen" class="screen hidden">
          <div class="char-card-wrap">
            <div id="talent-coins">
              <img src="assets/images/money.png" alt="金幣" id="talent-coins-icon">
              <span id="talent-coins-text">0</span>
            </div>
            <!-- 左上角：返回選角介面按鈕（依參考圖移位與調整尺寸） -->
            <button id="talent-back" class="top-left-icon-btn" aria-label="返回選角介面">
              <img src="assets/images/talent2.png" alt="返回選角" />
            </button>
            <h1 class="char-title">天賦系統</h1>
            <p class="char-subtitle">提示：選取天賦按空白鍵或雙擊解鎖，最高六階。</p>
            <div class="char-grid talent-grid">
              <button class="char-card selectable locked" data-talent-id="hp_boost">
                <img src="assets/images/test.png" alt="生命強化" class="grayscale" />
                <div class="char-name">生命強化</div>
              </button>
              <!-- 其他 11 個格子 -->
              <button class="char-card selectable locked" data-talent-id="defense_boost">
                <img src="assets/images/test2.png" alt="防禦強化" class="grayscale" />
                <div class="char-name">防禦強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="speed_boost">
                <img src="assets/images/test3.png" alt="移動加速" class="grayscale" />
                <div class="char-name">移動加速</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="pickup_range_boost">
                <img src="assets/images/test4.png" alt="拾取範圍增加" class="grayscale" />
                <div class="char-name">拾取範圍增加</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="damage_boost">
                <img src="assets/images/test5.png" alt="傷害強化" class="grayscale" />
                <div class="char-name">傷害強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="damage_specialization">
                <img src="assets/images/test6.png" alt="傷害特化" class="grayscale" />
                <div class="char-name">傷害特化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="crit_enhance">
                <img src="assets/images/test7.png" alt="爆擊強化" class="grayscale" />
                <div class="char-name">爆擊強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="regen_speed_boost">
                <img src="assets/images/test8.png" alt="回血強化" class="grayscale" />
                <div class="char-name">回血強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="experience_boost">
                <img src="assets/images/test10.png" alt="經驗值強化" class="grayscale" />
                <div class="char-name">經驗值強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="levelup_action_charges">
                <img src="assets/images/test9.png" alt="選項次數強化" class="grayscale" />
                <div class="char-name">選項次數強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="dodge_enhance">
                <img src="assets/images/test12.png" alt="迴避強化" class="grayscale" />
                <div class="char-name">迴避強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="defense_gold_boost">
                <img src="assets/images/test11.png" alt="消波塊增加" class="grayscale" />
                <div class="char-name">消波塊增加</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="chicken_blessing_boost">
                <img src="assets/images/test13.png" alt="雞腿強化" class="grayscale" />
                <div class="char-name">雞腿強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="sheep_guard_boost">
                <img src="assets/images/test14.png" alt="綿羊護體強化" class="grayscale" />
                <div class="char-name">綿羊護體強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="heart_companion_boost">
                <img src="assets/images/A34.png" alt="心意相隨強化" class="grayscale" />
                <div class="char-name">心意相隨強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="rotating_muffin_boost">
                <img src="assets/images/A31.png" alt="旋轉鬆餅強化" class="grayscale" />
                <div class="char-name">旋轉鬆餅強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="gravity_wave_boost">
                <img src="assets/images/A27.png" alt="引力強化" class="grayscale" />
                <div class="char-name">引力強化</div>
              </button>
              <button class="char-card selectable locked" data-talent-id="ai_boost">
                <img src="assets/images/AI.png" alt="AI強化" class="grayscale" />
                <div class="char-name">AI強化</div>
              </button>
              <div class="char-slot empty"></div>
            </div>
            <div class="char-preview" id="talent-preview" aria-live="polite">
              <div class="char-preview-image">
                <img id="talent-preview-img" src="assets/images/GM.png" alt="預覽" />
              </div>
              <div class="char-preview-info">
                <div class="char-preview-name" id="talent-preview-name">天賦系統</div>
                <div class="char-preview-desc" id="talent-preview-desc">這裡會顯示天賦介紹。</div>
                <div class="char-hint">提示：同一個天賦可以透過重複解鎖來升級，請不斷雙擊天賦進行解鎖。</div>
              </div>
            </div>
            
            <!-- 天賦解鎖確認彈窗 -->
            <div id="talent-confirm" class="hidden">
              <div class="talent-dialog">
                <div class="talent-dialog-title" id="talent-confirm-title">解鎖天賦</div>
                <div class="talent-dialog-desc" id="talent-confirm-desc">使用500金幣解鎖天賦？</div>
                <div class="talent-dialog-actions">
                  <button id="talent-confirm-ok" class="primary">確認</button>
                  <button id="talent-confirm-cancel" class="ghost">取消</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 腳本載入 -->
        <script src="js/deterministic_random.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/config.js"></script>
        <script src="js/resource_loader.js"></script>
        <script src="js/event-system.js"></script>
        <script src="js/damage_system.js"></script>
        <script src="js/buff-system.js"></script>
        <script src="js/input.js"></script>
        <script src="js/entity.js"></script>
        <script src="js/obstacle.js"></script>
        <script src="js/audio.js"></script>
        <script src="js/orbit.js"></script>
        <script src="js/laser.js"></script>
        <script src="js/aura_field.js"></script>
        <script src="js/gravity_wave.js"></script>
        <script src="js/sing.js"></script>
        <script src="js/young_dada_glory.js"></script>
        <script src="js/chain_lightning.js"></script>
        <script src="js/slash.js"></script>
        <script src="js/judgment.js"></script>
        <script src="js/divine_judgment.js"></script>
        <script src="js/explosion_effect.js"></script>
        <script src="js/deathline_warrior.js"></script>
        <script src="js/radiant_glory.js"></script>
        <script src="js/shockwave.js"></script>
        <script src="js/car_hazard.js"></script>
        <script src="js/boss_projectile.js"></script>
        <script src="js/bottle_projectile.js"></script>
        <script src="js/enemy.js?v=2026011309" onerror="console.error('[index.html] ❌ enemy.js 脚本加载失败！', this.src, event);"></script>
        <script src="js/experience.js?v=2026011309" onerror="console.error('[index.html] ❌ experience.js 脚本加载失败！', this.src, event);"></script>
        <script src="js/chest.js"></script>
    <script src="js/ui.js"></script>
        <!-- GIF 覆蓋層工具：確保玩家 GIF 在 Canvas 上正常動畫 -->
    <script src="js/gif_overlay.js"></script>
        <script src="js/wave.js?v=2026011309"></script>
        <script src="js/talent.js"></script>
    <script src="js/weapon.js?v=2026011306"></script>
    <script src="js/player.js"></script>
        <script src="js/projectile.js"></script>
        <script src="js/invincible.js"></script>
        <script src="js/ai_companion.js"></script>
        <script src="js/big_ice_ball.js"></script>
        <script src="js/frenzy_young_dada_glory.js"></script>
        <!-- 可選彈幕系統骨架（需在 game.js 之前載入） -->
        <script src="js/bullet-system.js"></script>
        <script src="js/achievements.js"></script>
        <script src="js/game.js"></script>
        <script src="js/integration.js"></script>
        <script src="js/save_code.js"></script>
        <script src="js/redeem_code.js"></script>
        <!-- 核心服務與模式管理（不改動 SaveCode；僅新增骨架） -->
        <script src="js/core/services/save_service.js"></script>
        <script src="js/core/services/resource_loader.js"></script>
        <!-- 注意：ModeManager 僅保留作為『回退』用途，請勿在新模式上使用。
             未來新增/啟動模式請一律改用 GameModeManager.register/start。 -->
        <script src="js/core/mode_manager.js"></script>
        <!-- 主用：隔離化 GameModeManager（新模式與主線模式皆走此管理器） -->
        <script src="js/core/game_mode_manager.js"></script>
        <!-- Three.js 庫（3D模式需要） -->
        <!-- 使用ES6模块版本的Three.js，以便GLTFLoader可以正确导入 -->
        <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
          }
        }
        </script>
        <script type="module">
        // 导入Three.js和GLTFLoader
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        // 挂载到全局，供非模块代码使用
        window.THREE = THREE;
        window.GLTFLoader = GLTFLoader;
        window.GLTFLoaderReady = true;
        console.log('[3D Mode] Three.js and GLTFLoader loaded successfully');
        window.dispatchEvent(new CustomEvent('gltfloader-ready'));
        </script>
        <!-- 生存模式適配層：封裝既有生存模式為 Mode 介面 -->
        <script src="js/modes/survival/index.js"></script>
        <!-- 挑戰模式專屬 GIF 覆蓋層：獨立於生存模式，避免汙染 -->
        <script src="js/modes/challenge/gif_overlay.js"></script>
        <!-- 挑戰模式 UI 模組：提供 HUD 與 ESC 菜單 -->
        <script src="js/modes/challenge/ui.js"></script>
        <!-- 挑戰模式：專屬彈幕系統 + 樣式庫與 BOSS 控制器（在骨架 index.js 之前） -->
        <script src="js/modes/challenge/bullet_system.js"></script>
        <!-- 挑戰模式專用雷射美術，不影響其他模式 -->
        <script src="js/modes/challenge/laser_art.js"></script>
        <script src="js/modes/challenge/boss_patterns.js"></script>
        <script src="js/modes/challenge/boss_patterns2.js"></script>
        <script src="js/modes/challenge/boss_patterns3.js"></script>
        <script src="js/modes/challenge/boss_patterns4.js"></script>
        <!-- 挑戰模式專屬經驗系統：與生存模式的經驗分離 -->
        <script src="js/modes/challenge/experience.js"></script>
        <script src="js/modes/challenge/boss.js"></script>
        <script src="js/modes/challenge/boss2.js"></script>
        <script src="js/modes/challenge/boss3.js"></script>
        <script src="js/modes/challenge/boss4.js"></script>
        <!-- 挑戰模式骨架：接入隔離化 GameModeManager -->
        <script src="js/modes/challenge/index.js"></script>
        <!-- 闖關模式 UI 模組：提供 HUD 與 ESC 菜單 -->
        <script src="js/modes/stage/ui.js"></script>
        <!-- 闖關模式骨架：接入隔離化 GameModeManager -->
        <script src="js/modes/stage/index.js"></script>
        <!-- 防禦模式專用 GIF 疊加層 -->
        <script src="js/modes/defense/td_gif_overlay.js"></script>
        <!-- 防禦模式核心組件 -->
        <script src="js/modes/defense/td_config.js"></script>
        <!-- 防禦模式傷害數字系統（獨立於生存模式，避免跨模式污染） -->
        <script src="js/modes/defense/td_damage_numbers.js"></script>
        <script src="js/modes/defense/td_map.js"></script>
        <script src="js/modes/defense/td_enemy.js"></script>
        <script src="js/modes/defense/td_tower.js"></script>
        <script src="js/modes/defense/td_player.js"></script>
        <script src="js/modes/defense/td_game.js"></script>
        <script src="js/modes/defense/td_ui_enhanced.js"></script>
        <script src="js/modes/defense/td_dom_ui.js"></script>
        <script src="js/modes/defense/td_settlement.js"></script>
        
        <!-- 防禦模式 UI 模組：提供 HUD 與 ESC 菜單 --> 
        <script src="js/modes/defense/ui.js"></script> 
        <!-- 防禦模式骨架：接入隔離化 GameModeManager --> 
        <script src="js/modes/defense/index.js"></script>
        <!-- 主線模式圖層配置 -->
        <script src="js/modes/main/layer_config.js"></script>
        <!-- 主線模式專用 GIF 疊加層 -->
        <script src="js/modes/main/gif_overlay.js"></script>
        <!-- 主線模式骨架：不分難度，探索 + NPC 對話 -->
        <script src="js/modes/main/index.js"></script>
        <!-- 冒險模式引繼碼工具（僅操作 terraria_save，不動主體 SaveCode） -->
        <script src="js/modes/adventure/adventure_save_code.js"></script>
        <!-- 冒險模式骨架：以 iframe 掛載獨立 Terraria 風格遊戲 -->
        <script src="js/modes/adventure/index.js"></script>
        <!-- 3D模式骨架：使用Three.js載入3D模型並實現角色控制 -->
        <script src="js/modes/3d/index.js"></script>
        <!-- 生存模式組隊（測試）：Firebase signaling + WebRTC relay-only；僅在生存模式流程中使用 -->
        <!-- 注意：加上版本參數避免 GitHub Pages / 瀏覽器快取舊版 JS 造成規則調試困難 -->
        <script type="module" src="js/multiplayer/survival_online.js?v=2026011304"></script>
        <script src="js/main.js"></script>
    </div>
    <!-- 統一的過渡層（所有模式共用，播放 LOAD.mp4） -->
    <div id="transition-layer" class="hidden">
        <video id="transition-video" autoplay muted playsinline>
            <source src="assets/videos/LOAD.mp4" type="video/mp4">
        </video>
    </div>
</body>
</html>

